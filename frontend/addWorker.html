<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>


    <!-- CORAL -->
    <link rel="stylesheet" href="https://unpkg.com/@adobe/coral-spectrum@4.5.0/dist/css/coral.min.css">
    <script src="https://unpkg.com/@adobe/coral-spectrum@4.5.0/dist/js/coral.min.js"
        data-coral-icons-external="js"></script>

    <!-- AJV + RACTIVE -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ajv/8.12.0/ajv7.min.js"
        integrity="sha512-U2SW9Ihh3GF6F8gP8QgLS+I244xnM5pFCh3cigpw7bAzUDnKDlxdlFL4kjyXTle8SJl/tJ0gdnwd44Eb3hLG/Q=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ractive/1.4.2/ractive.min.js"
        integrity="sha512-UU/Ei0ZsTSuTyn6OiX4SODfkUxsCXTy2RSjsqSxDRHiWeF+JByhOCp1ZOXPywHhTujMUw+qZymBjwFqWdmDkTg=="
        crossorigin="anonymous" referrerpolicy="no-referrer"></script>



        <!-- BOOTSTRAP -->

        <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet"
            integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">
        <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz"
            crossorigin="anonymous"></script>


<!-- DATEPICKER -->
            <script src="
                https://cdn.jsdelivr.net/npm/air-datepicker@3.3.5/air-datepicker.min.js
                "></script>
            
            <link href="
                https://cdn.jsdelivr.net/npm/air-datepicker@3.3.5/air-datepicker.min.css
                " rel="stylesheet">
            

    <script src="http://localhost:4020/utils/components.js"></script>
    <script src="http://localhost:4020/utils/redirectionManager.js"></script>
    <script src="http://localhost:4020/utils/utils.js"></script>

            <!-- BUNDLE -->
            
            <script src="http://localhost:4020/utils/bundle.js"></script>


</head>

<body class="coral--light">




    <style>
        .fileUpload-dropZone {
            border: 1px dashed rgb(150, 150, 150);
            padding: 10px;
            margin-bottom: 10px;
        }
    </style>



    <div id="header-menu"></div>
    <div id="nav"></div>
    

    <div style="
    display: flex;
    justify-content: space-between;
    flex-direction: column;
    align-items: center;
    padding:10px" ">

   <!--  <h2>Загрузите фото работника:</h2>
        <div id="fileupload" style="padding-bottom: 2rem;"></div>
    <hr class="coral-Divider--L"> -->
    <h2>Заполните персональные данные работника:</h2>
    <form class="coral-FormGroup" id="new-worker" style="padding-top: 2rem;">
        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel" for="fieldLabelExample2-emailaddress">Имя
                :</label>
            <div class="coral-FormGroup-itemField">
                <input   is="coral-textfield"  type="text" placeholder="Имя" name="name">
            </div>
        </div>

        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left"
                for="fieldLabelExample2-emailaddress">Фамилия:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" type="text" placeholder="Фамилия" name="last-name">
            </div>
        </div>

        <!-- ADD HINT HERE-->
        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Ссылка
                на instagram:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" type="text" placeholder="Instagram" name="insta-ref">
            </div>
        </div>


        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Ссылка
                на facebook:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" type="text" placeholder="Facebook" name="facebook-ref">
            </div>
        </div>

        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Ссылка
                на telegram:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" type="text" placeholder="Telegram" name="telegram-ref">
            </div>
        </div>

        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Номер
                whatsapp:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" type="text" placeholder="whatsapp"
                    name="whatsapp-number">
            </div>
        </div>

        <!-- MAKE SELECT FOR POLAND (DEFAULT) + another countries phonecode -->

        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Номер
                телефона:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" type="text" placeholder="Номер телефона"
                    name="phone-number">
            </div>
        </div>

        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Логин работника:</label>
            <div class="coral-FormGroup-itemField">
                <input is="coral-textfield" aria-invalid="false" id="login-input" type="text" placeholder="Логин" name="login">
                <button  type="button" is="coral-button" id="generate-login">Сгенерировать логин</button> 
            </div>
        </div>

        <div class="coral-FormGroup-item">
            <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Пароль:</label>
            <div class="coral-FormGroup-itemField">
                <input value="12345" disabled="" is="coral-textfield" aria-invalid="false" type="text" placeholder="Пароль" name="password">
            </div>
        </div>
        

        <div id="birth" class="coral-FormGroup-item">
        </div>

        <!-- DATE PICKER-->

        <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Уровень:</label>
        <coral-select name="level">
            <coral-select-item value="education">
                Обучение
            </coral-select-item>
            <coral-select-item value="intern">
                Стажировка
            </coral-select-item>
            <coral-select-item value="junior">
                Начинающий
            </coral-select-item>
            <coral-select-item value="middle">
                Средний
            </coral-select-item>
            <coral-select-item value="senior">
                Топ-мастер
            </coral-select-item>
        </coral-select>

    <div class="coral-FormGroup-item">
        <label class="coral-FormGroup-itemLabel coral-FieldLabel--left" for="fieldLabelExample2-emailaddress">Специлизация:</label>
        <coral-select multiple="" name="occupation">
            <coral-select-item value="electrolysis">
                Электроэпиляция
            </coral-select-item>
            <coral-select-item value="laser_epilation">
                Лазерная эпиляция
            </coral-select-item>
            <coral-select-item value="eyelashes">
                Ресницы/Брови
            </coral-select-item>
        </coral-select>
    </div>

        <!--DESCRIPTION-->
        <div class="coral-FormGroup-item">
            <label for="fieldLabelExample2-lifestory" class="coral-FormGroup-itemLabel coral-FieldLabel--left">Доп
                информация о клиенте : </label>
            <div class="coral-FormGroup-itemField">
                <textarea rows="4" style="resize:none"  id="fieldLabelExample2-lifestory" placeholder="Инфо" name="description"
                    is="coral-textarea"></textarea>
            </div>
        </div>

    </form>
    <button style="width:100%; margin-top:1rem" type="button" is="coral-button" id="btn-submit">Добавить</button>
    <coral-toast id="addWorkerToast"></coral-toast>
    </div>



    <script>
        // REDIRECT IF NO USER
        window.RedirectionManager.checkUserExists()

        Ractive({
            target: "#header-menu",
            template: `<header-c /> `
        });


        Ractive({
                target: "#nav",
                template: `<nav-c /> `
            });

        Ractive({
            target: "#fileupload",
            template: `<fileupload-c /> `
        });

        Ractive({
            target: "#birth",
            template: `<calendar-c /> `,
        });

    </script>


    <script>

        const Ajv = window.ajv7;
        const ajv = new Ajv()

        const schema = {
                type: "object",
                properties: {
                    name: { type: "string" },
                    "last-name": { type: "string" },
                    "insta-ref": { type: ["string", "null"] },
                    "facebook-ref": { type: ["string", "null"] },
                    "telegram-ref": { type: ["string", "null"] },
                    "whatsapp-number": { type: ["string", "null"] },
                    "phone-number": { type: ["string", "null"] },
                    "login" : { type: ["string", "null"] },
                    "password": { type: ["string", "null"] },
                    "level" : {type:["string" ,  "array"]},
                    "occupation" : { type: ["string", "array"] },
                    "date-of-birth": { type: ["string", "null"] },
                    "description": { type: "string" }
                },
                required: ["name", "last-name", "level" , "occupation" ,  "login" ],
                additionalProperties: true
            }

        let objData = {}
        let btn = document.getElementById("btn-submit");
        let btnGenerateLogin = document.getElementById("generate-login");
        console.log("BTN", btn)
        // TODO finish 


        btnGenerateLogin.addEventListener("click",  ()=>{
            let login =  window.UtilsManager.generateRandomLogin();
            let input =  document.getElementById("login-input") 
            input.value = login
        })

        btn.addEventListener("click", () => {
            let formEl = document.forms["new-worker"];
            let formData = new FormData(formEl);
            // for (const pair of formData.entries()) {
            //     objData[pair[0]] = pair[1]
            //     console.log(`${pair[0]}, ${pair[1]}`);
            // }

            let objData = window.UtilsManager.buildObjectFromFormData(formData)
            let result = window.AJVManager.checkFormAndBuildErrors(schema, objData, "new-worker");
            if(!result) return

            let user =  JSON.parse(localStorage.getItem("user"));
            let userId = user._id;
           
            formData.append("added_by", userId)
            formData.append("role", "worker")
            formData.append("company", user.company_name)
            formData.append("password", "12345")

            // TODO FINISH
            fetch("/addUser",
                {
                    method: "POST",
                    headers: {},
                    body: formData //formData
                }).then((response) => {
                    return response.json();
                })
                .then((data) => { 
                    document.getElementById("addWorkerToast").querySelector("coral-toast-content").innerText = data.message;
                    document.getElementById("addWorkerToast").show()
                });
        })

    </script>



</body>

</html>